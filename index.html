import tkinter as tk
from tkinter import ttk, messagebox, filedialog
import json, os, re, random
import zipfile, shutil

from datetime import datetime

# ---------- PDF + PNG/JPG ----------
try:
    from reportlab.lib.pagesizes import A4
    from reportlab.lib import colors
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer
    from reportlab.lib.styles import getSampleStyleSheet
    PDF_OK = True
except ImportError:
    PDF_OK = False

try:
    import pyautogui
    from PIL import Image
    IMG_OK = True
except ImportError:
    IMG_OK = False

# ---------- Matplotlib ----------
try:
    import matplotlib.pyplot as plt
    from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
    CHART_OK = True
except ImportError:
    CHART_OK = False

# ---------------- UNDO / REDO ----------------
undo_stack = []
redo_stack = []

def push_snapshot():
    """Save current stanje and MERE to undo stack before any change."""
    undo_stack.append((ucitaj_stanje(), ucitaj_proiz()))
    redo_stack.clear()

def _restore_snapshot(snap):
    prev_st, prev_mere = snap
    sacuvaj_stanje(prev_st)
    sacuvaj_proiz(prev_mere)
    global MERE, PROIZVODI
    MERE = prev_mere
    PROIZVODI = list(MERE.keys())
    proizvod_menu.configure(values=PROIZVODI)

def korak_unazad():
    if not undo_stack:
        messagebox.showinfo("Undo", "Nema više koraka unazad.")
        return
    redo_stack.append((ucitaj_stanje(), ucitaj_proiz()))
    snap = undo_stack.pop()
    _restore_snapshot(snap)
    prikazi()
def korak_unapred():
    if not redo_stack:
        messagebox.showinfo("Redo", "Nema više koraka unapred.")
        return
    undo_stack.append((ucitaj_stanje(), ucitaj_proiz()))
    snap = redo_stack.pop()
    _restore_snapshot(snap)
    prikazi()

# ---------------------------------------------------------------

DATA_FILE      = "stanje_magacina.json"
PROIZVODI_FILE = "proizvodi.json"
LOG_FILE       = "log_magacin.json"
BACKUP_META_FILE = "backup_meta.json"

GORNJE_VALUTE = ["RSD","EUR","USD","CHF","GBP"]
EVR_VALUTE    = ["ALL","AMD","AZN","BAM","BGN","CZK","DKK","GEL","HRK","HUF",
                 "ISK","MDL","MKD","NOK","PLN","RON","RUB","SEK","TRY","UAH"]
SVE_VALUTE = GORNJE_VALUTE + EVR_VALUTE

# ---------- inicijalni fajlovi ----------
for f, init in (
    (DATA_FILE, {}),
    (LOG_FILE , []),
    (PROIZVODI_FILE, {
        "Luster kuka":{
            "3x30":{"cena":1.6,"valuta":"EUR","sifra":"LK-330"},
            "4x40":{"cena":2.0,"valuta":"EUR","sifra":"LK-440"}},
        "Rajber kuka":{
            "5x50":{"cena":220,"valuta":"RSD","sifra":"RK-550"},
            "6x60":{"cena":250,"valuta":"RSD","sifra":"RK-660"}},
    })
):
    if not os.path.exists(f):
        with open(f, "w", encoding="utf-8") as fp:
            json.dump(init, fp, indent=4)

# ---------- helper (više nema lambda) ----------
def ucitaj_stanje():
    with open(DATA_FILE, encoding="utf-8") as f:
        return json.load(f)

def sacuvaj_stanje(s):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(s, f, indent=4)

def ucitaj_proiz():
    with open(PROIZVODI_FILE, encoding="utf-8") as f:
        return json.load(f)

def sacuvaj_proiz(p):
    with open(PROIZVODI_FILE, "w", encoding="utf-8") as f:
        json.dump(p, f, indent=4)

def ucitaj_log():
    with open(LOG_FILE, encoding="utf-8") as f:
        return json.load(f)

def sacuvaj_log(l):
    with open(LOG_FILE, "w", encoding="utf-8") as f:
        json.dump(l, f, indent=4)
